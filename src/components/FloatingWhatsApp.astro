---
import { WHATSAPP_BOOKING_LINK, WHATSAPP_BOOKING_LINK_HI } from '../lib/constants';
import { detectLangFromPath } from '../lib/i18n';

const currentLang = detectLangFromPath(Astro.url.pathname);
const isHindi = currentLang === 'hi';
const whatsappLink = isHindi ? WHATSAPP_BOOKING_LINK_HI : WHATSAPP_BOOKING_LINK;
const bubbleText = isHindi
  ? 'अयोध्या नगरी में आपका स्वागत है! श्री जानकी महल में अच्छे दामों पर सर्वोत्तम कमरे बुक करें।'
  : 'Welcome to Ayodhya. Book verified rooms at Sri Janaki Mahal Trust on WhatsApp.';
const closeLabel = isHindi ? 'बंद करें' : 'Close';
const chatLabel = isHindi ? 'WhatsApp पर चैट करें' : 'Chat on WhatsApp';
---

<!--
  Mobile layout note:
  - Use smaller insets on very small screens so the button never gets clipped.
  - Bubble width is capped to viewport so it doesn't overflow.
-->
<div class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-40 flex flex-col items-end gap-2">
  <!-- Bubble message, shown after delay -->
  <div
    id="whatsapp-bubble-text-container"
    class="hidden relative group animate-fade-in max-w-[calc(100vw-6rem)] sm:max-w-[18rem]"
  >
    <span
      class="block bg-white rounded-xl rounded-br-md shadow-lg px-4 py-2 text-green-900 text-base font-medium border-l-4 border-green-500 leading-tight"
    >
      {bubbleText}
    </span>
    <button
      id="wa-close-bubble"
      class="absolute -top-2 -right-2 bg-gray-200 hover:bg-red-400 text-gray-900 rounded-full w-6 h-6 flex items-center justify-center text-sm font-semibold shadow border border-gray-300 transition-all"
      aria-label={closeLabel}
      type="button"
      tabindex="0"
    >&times;</button>
  </div>
  <div class="relative w-16 h-16 flex items-center justify-center">
    <span
      class="absolute inset-0 rounded-full bg-green-400/80 animate-ping z-0 motion-reduce:hidden"
      aria-hidden="true"
    ></span>
    <a
      href={whatsappLink}
      target="_blank"
      rel="noopener noreferrer"
      class="relative z-10 flex items-center justify-center w-16 h-16 rounded-full bg-green-500 text-white shadow-2xl hover:bg-green-600 transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-green-300 group"
      title={chatLabel}
      aria-label={chatLabel}
      onclick={`return gtag_report_conversion('${whatsappLink}');`}
    >
      <!-- Proper WhatsApp SVG Icon from official source (https://worldvectorlogo.com/logo/whatsapp-icon-1) -->
      <svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 48 48" class="block" aria-hidden="true">
        <g>
          <circle fill="#25d366" cx="24" cy="24" r="24"/>
          <path fill="#fff" d="M36.45,11.55c-2.93-2.93-6.83-4.55-10.98-4.55C14.49,7,7,14.49,7,24c0,2.02,0.52,3.98,1.52,5.73 l-1.61,5.88c-0.19,0.69,0.46,1.33,1.15,1.15l5.88-1.61C20.02,40.48,21.98,41,24,41c9.51,0,17-7.49,17-17 C41,18.38,39.39,14.48,36.45,11.55z M24,38.62c-1.78,0-3.54-0.47-5.08-1.35l-0.37-0.21l-3.49,0.96l0.95-3.41l-0.24-0.4 C13.7,31.18,13.15,29.62,13.15,28c0-6.1,4.96-11.06,11.06-11.06c2.96,0,5.75,1.15,7.86,3.25c2.11,2.11,3.25,4.9,3.25,7.86 C38.06,33.66,32.11,38.62,24,38.62z"/>
          <path fill="#fff" d="M32,28.79c-0.27-0.13-1.6-0.79-1.85-0.88c-0.25-0.09-0.43-0.13-0.62,0.13c-0.19,0.27-0.73,0.88-0.89,1.06 c-0.16,0.17-0.32,0.2-0.59,0.07c-0.27-0.13-1.15-0.42-2.18-1.38c-0.81-0.73-1.37-1.63-1.53-1.9c-0.16-0.27-0.02-0.42,0.11-0.56 c0.12-0.13,0.27-0.34,0.41-0.5c0.14-0.17,0.18-0.29,0.29-0.48c0.1-0.19,0.05-0.36-0.02-0.53c-0.07-0.16-0.61-1.46-0.84-2.01 c-0.24-0.56-0.48-0.48-0.65-0.49c-0.17-0.01-0.35-0.01-0.54-0.01c-0.19,0-0.48,0.07-0.73,0.33c-0.25,0.27-0.97,0.94-0.97,2.29 c0,1.35,0.98,2.66,1.11,2.84c0.13,0.18,1.75,2.66,4.24,3.72c0.59,0.25,1.05,0.41,1.41,0.52c0.59,0.18,1.12,0.16,1.55,0.1 c0.47-0.07,1.45-0.61,1.65-1.19c0.2-0.58,0.2-1.08,0.14-1.19C32.45,28.96,32.26,28.91,32,28.79z"/>
        </g>
      </svg>
    </a>
  </div>
</div>
<script is:inline>
  try {
    const DISMISS_KEY = 'waBubbleDismissed';
    const SHOW_AFTER_MS = 2500;
    const SHOW_AFTER_SCROLL_PX = 120;

    const wrap = document.getElementById('whatsapp-bubble-text-container');
    const close = document.getElementById('wa-close-bubble');

    const alreadyDismissed = (() => {
      try {
        return window.localStorage.getItem(DISMISS_KEY) === '1';
      } catch {
        return false;
      }
    })();

    const hideBubble = () => {
      if (!wrap) return;
      wrap.classList.add('hidden');
      try {
        window.localStorage.setItem(DISMISS_KEY, '1');
      } catch {
        // ignore
      }
    };

    const showBubble = () => {
      if (!wrap || alreadyDismissed) return;
      wrap.classList.remove('hidden');
    };

    if (close) {
      close.onclick = () => hideBubble();
    }

    let shown = false;
    const maybeShow = () => {
      if (shown || alreadyDismissed) return;
      if (window.scrollY >= SHOW_AFTER_SCROLL_PX) {
        shown = true;
        showBubble();
        window.removeEventListener('scroll', maybeShow);
      }
    };

    window.addEventListener('scroll', maybeShow, { passive: true });
    setTimeout(() => {
      if (!shown) showBubble();
    }, SHOW_AFTER_MS);
  } catch {
    // no-op: do not block page rendering
  }
</script>
