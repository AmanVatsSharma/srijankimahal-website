<!-- // src/pages/blog/[slug].astro -->
---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { generateBreadcrumbSchema, generateStandardBreadcrumbs } from '../../lib/schemas/breadcrumb';

type MarkdownModule = {
  frontmatter: {
    title: string;
    description: string;
    date: string;
    keywords?: string[];
    readTime?: string;
    wordCount?: number;
  };
  Content: any;
  compiledContent?: () => Promise<string>;
  rawContent?: string | (() => Promise<string>);
};

type BlogEntry = {
  slug: string;
  frontmatter: MarkdownModule['frontmatter'];
  Content: MarkdownModule['Content'];
};

// NOTE: generate static paths for every markdown file so no blog link returns 404
export async function getStaticPaths() {
  const getReadingStats = (content: string | undefined) => {
    const safeContent = content?.trim();
    if (!safeContent) {
      return {
        readTime: '5 min read',
        wordCount: 0,
      };
    }

    const words = safeContent.split(/\s+/).filter(Boolean).length;
    const minutes = Math.max(1, Math.round(words / 200));
    return {
      readTime: `${minutes} min read`,
      wordCount: words,
    };
  };

  const blogImports = import.meta.glob('../../content/blog/*.md');
  const hindiBlogImports = import.meta.glob('../../content/blog/hi/*.md');
  const hindiSlugs = new Set(
    Object.keys(hindiBlogImports).map((path) => path.split('/').pop()?.replace('.md', '') ?? '')
  );
  const entries: BlogEntry[] = await Promise.all(
    Object.entries(blogImports).map(async ([path, resolver]) => {
      const mod = (await resolver()) as MarkdownModule;
      const slug = path.split('/').pop()?.replace('.md', '') ?? '';

      let rawContent = '';
      if (typeof mod.rawContent === 'string') {
        rawContent = mod.rawContent;
      } else if (typeof mod.rawContent === 'function') {
        rawContent = await mod.rawContent();
      } else if (typeof mod.compiledContent === 'function') {
        rawContent = await mod.compiledContent();
      }

      const readingStats = getReadingStats(rawContent);
      const readTime = mod.frontmatter.readTime ?? readingStats.readTime;
      const wordCount = mod.frontmatter.wordCount ?? readingStats.wordCount;

      return {
        slug,
        frontmatter: {
          ...mod.frontmatter,
          readTime,
          wordCount,
        },
        Content: mod.Content,
      };
    })
  );

  // NOTE: keep posts ordered by date so we can reuse this order for related articles
  entries.sort((a, b) => {
    const dateA = new Date(a.frontmatter.date).getTime();
    const dateB = new Date(b.frontmatter.date).getTime();
    return dateB - dateA;
  });

  const allPosts = entries.map(({ slug, frontmatter }) => ({ slug, frontmatter }));

  return entries.map(({ slug, frontmatter, Content }) => ({
    params: { slug },
    props: {
      slug,
      frontmatter,
      Content,
      allPosts,
      hasHindiAlternate: hindiSlugs.has(slug),
    },
  }));
}

const { slug, frontmatter, Content, allPosts, hasHindiAlternate } = Astro.props as {
  slug: string;
  frontmatter: MarkdownModule['frontmatter'];
  Content: MarkdownModule['Content'];
  allPosts: Array<{ slug: string; frontmatter: MarkdownModule['frontmatter'] }>;
  hasHindiAlternate: boolean;
};

const post = {
  slug,
  ...frontmatter,
};

// NOTE: build keyword list without duplicates and keep them relevant to booking intent
const baseKeywords = [
  'Sri Janaki Mahal Trust',
  'Sri Janaki Mahal Trust room booking',
  'Sri Janaki Mahal Trust official',
  'Sri Janaki Mahal Trust online booking',
  'book room online',
  'Ayodhya hotel',
  'Ayodhya guest house near Ram Mandir',
];
const keywordSet = new Set([...baseKeywords, ...(post.keywords ?? [])]);
const keywords = Array.from(keywordSet);

// NOTE: derive related posts by excluding the current slug and picking the top 3 most recent
const relatedPosts = allPosts.filter((entry) => entry.slug !== slug).slice(0, 3);

// NOTE: breadcrumbs stay consistent with the rest of the site
const breadcrumbs = generateStandardBreadcrumbs('Blog', '/blog');
breadcrumbs.push({ name: post.title, url: `/blog/${slug}` });
const breadcrumbSchema = generateBreadcrumbSchema(breadcrumbs);

const canonicalUrl = `https://www.srijanakimahaltrustofficial.com/blog/${slug}`;
const publishedIso = new Date(post.date).toISOString();
const alternateLanguages = hasHindiAlternate
  ? [
      { lang: 'en', url: `/blog/${slug}` },
      { lang: 'hi', url: `/hi/blog/${slug}` },
    ]
  : [{ lang: 'en', url: `/blog/${slug}` }];

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl,
  },
  headline: post.title,
  description: post.description,
  datePublished: publishedIso,
  dateModified: publishedIso,
  inLanguage: 'en-IN',
  articleSection: 'Ayodhya Travel Guide',
  keywords: keywords.join(', '),
  wordCount: post.wordCount,
  author: {
    '@type': 'Organization',
    name: 'Sri Janaki Mahal Trust',
    url: 'https://www.srijanakimahaltrustofficial.com/',
  },
  publisher: {
    '@type': 'Organization',
    name: 'Sri Janaki Mahal Trust',
    logo: {
      '@type': 'ImageObject',
      url: 'https://www.srijanakimahaltrustofficial.com/favicon.svg',
    },
  },
  image: ['https://www.srijanakimahaltrustofficial.com/og.jpg'],
};
---

<Layout 
  title={`${post.title} | Blog`}
  description={post.description}
  keywords={keywords}
  canonical={`/blog/${slug}`}
  ogType="article"
  ogImage={'/og.jpg'}
  alternateLanguages={alternateLanguages}
  disableDefaultHreflangPair={true}
>
  <Fragment slot="head">
    <meta property="article:published_time" content={publishedIso} />
    <meta property="article:modified_time" content={publishedIso} />
    <meta property="article:section" content="Ayodhya Travel Guide" />
  </Fragment>
  <Header />
  
  <main class="min-h-screen bg-[#faf8f3] py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      {/* Breadcrumbs */}
      <nav class="mb-6 text-sm" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-gray-600">
          <li><a href="/" class="hover:text-amber-600">Home</a></li>
          <li>/</li>
          <li><a href="/blog" class="hover:text-amber-600">Blog</a></li>
          <li>/</li>
          <li class="text-gray-900">{post.title}</li>
        </ol>
      </nav>

      {/* Article Header */}
      <header class="mb-8">
        {/* Keep visual title while preserving single semantic H1 in markdown content */}
        <p class="text-4xl sm:text-5xl font-bold text-gray-900 mb-4">
          {post.title}
        </p>
        <div class="flex items-center gap-4 text-sm text-gray-600 mb-6">
          <time datetime={post.date}>
            {new Date(post.date).toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
          <span>•</span>
          <span>{post.readTime ?? '5 min read'}</span>
        </div>
        <p class="text-xl text-gray-700 leading-relaxed">
          {post.description}
        </p>
      </header>

      {/* Article Content */}
      <article class="bg-white rounded-lg shadow-lg p-8 prose prose-lg max-w-none">
        <Content />
      </article>

      {/* Call to Action */}
      <div class="mt-12 bg-gradient-to-r from-amber-600 to-rose-600 rounded-lg p-8 text-center text-white">
        <h2 class="text-2xl font-bold mb-4">Book Your Stay at Sri Janaki Mahal Trust</h2>
        <p class="text-lg mb-6 opacity-90">
          Comfortable rooms near Ram Mandir with meals included. Call or WhatsApp for instant booking.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a 
            href="tel:+919102319329"
            class="px-6 py-3 bg-white text-amber-600 font-bold rounded-lg hover:bg-gray-100 transition-colors"
          >
            Call: +91 9102319329
          </a>
          <a 
            href="https://wa.me/919102319329"
            target="_blank"
            rel="noopener noreferrer"
            class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors"
          >
            WhatsApp Booking
          </a>
        </div>
      </div>

      {/* Verified booking links (internal linking hub) */}
      <div class="mt-10 bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-3">Verified Booking Links</h2>
        <ul class="list-disc list-inside text-gray-700 space-y-2">
          <li><a class="text-amber-700 font-semibold hover:underline" href="/official-booking">Official booking page</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/booking-verification-guide">Booking verification guide</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/how-to-avoid-scams">Avoid fake bookings (scam prevention)</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/rooms">Room types & prices</a></li>
        </ul>
      </div>

      {/* Related Posts */}
      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Related Articles</h2>
        <div class="grid md:grid-cols-2 gap-6">
          {relatedPosts.map((relatedPost) => (
            <a 
              href={`/blog/${relatedPost.slug}`}
              class="block bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow"
            >
              <h3 class="text-xl font-bold text-gray-900 mb-2 hover:text-amber-600">
                {relatedPost.frontmatter.title}
              </h3>
              <p class="text-gray-600 text-sm mb-3">{relatedPost.frontmatter.description}</p>
              <span class="text-amber-600 font-semibold text-sm">Read more →</span>
            </a>
          ))}
        </div>
      </div>
    </div>
  </main>

  {/* Breadcrumb Schema */}
  {breadcrumbSchema && (
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  )}

  {/* Article Schema */}
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <Footer />
</Layout>
