<!-- // src/pages/hi/blog/[slug].astro -->
---
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import { generateBreadcrumbSchema, generateStandardBreadcrumbs } from '../../../lib/schemas/breadcrumb';

type MarkdownModule = {
  frontmatter: {
    title: string;
    description: string;
    date: string;
    keywords?: string[];
    readTime?: string;
  };
  Content: any;
  compiledContent?: () => Promise<string>;
  rawContent?: string | (() => Promise<string>);
};

type BlogEntry = {
  slug: string;
  frontmatter: MarkdownModule['frontmatter'];
  Content: MarkdownModule['Content'];
};

export async function getStaticPaths() {
  const calculateReadTime = (content: string | undefined) => {
    const safeContent = content?.trim();
    if (!safeContent) return '5 min read';
    const words = safeContent.split(/\s+/).filter(Boolean).length;
    const minutes = Math.max(1, Math.round(words / 200));
    return `${minutes} min read`;
  };

  const blogImports = import.meta.glob('../../../content/blog/hi/*.md');
  const entries: BlogEntry[] = await Promise.all(
    Object.entries(blogImports).map(async ([path, resolver]) => {
      const mod = (await resolver()) as MarkdownModule;
      const slug = path.split('/').pop()?.replace('.md', '') ?? '';

      let rawContent = '';
      if (typeof mod.rawContent === 'string') rawContent = mod.rawContent;
      else if (typeof mod.rawContent === 'function') rawContent = await mod.rawContent();
      else if (typeof mod.compiledContent === 'function') rawContent = await mod.compiledContent();

      const readTime = mod.frontmatter.readTime ?? calculateReadTime(rawContent);
      return {
        slug,
        frontmatter: { ...mod.frontmatter, readTime },
        Content: mod.Content,
      };
    })
  );

  entries.sort((a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime());
  const allPosts = entries.map(({ slug, frontmatter }) => ({ slug, frontmatter }));

  return entries.map(({ slug, frontmatter, Content }) => ({
    params: { slug },
    props: { slug, frontmatter, Content, allPosts },
  }));
}

const { slug, frontmatter, Content, allPosts } = Astro.props as {
  slug: string;
  frontmatter: MarkdownModule['frontmatter'];
  Content: MarkdownModule['Content'];
  allPosts: Array<{ slug: string; frontmatter: MarkdownModule['frontmatter'] }>;
};

const post = { slug, ...frontmatter };
const baseKeywords = [
  'श्री जानकी महल ट्रस्ट',
  'अयोध्या रूम बुकिंग',
  'राम मंदिर के पास ठहरना',
  'सत्यापित बुकिंग',
];
const keywordSet = new Set([...(baseKeywords as string[]), ...(post.keywords ?? [])]);
const keywords = Array.from(keywordSet);

const relatedPosts = allPosts.filter((entry) => entry.slug !== slug).slice(0, 3);

const breadcrumbs = generateStandardBreadcrumbs('Blog', '/hi/blog');
breadcrumbs.push({ name: post.title, url: `/hi/blog/${slug}` });
const breadcrumbSchema = generateBreadcrumbSchema(breadcrumbs);

const canonicalUrl = `https://www.srijanakimahaltrustofficial.com/hi/blog/${slug}`;
const publishedIso = new Date(post.date).toISOString();

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  mainEntityOfPage: { '@type': 'WebPage', '@id': canonicalUrl },
  headline: post.title,
  description: post.description,
  datePublished: publishedIso,
  dateModified: publishedIso,
  author: { '@type': 'Organization', name: 'Sri Janaki Mahal Trust', url: 'https://www.srijanakimahaltrustofficial.com/' },
  publisher: {
    '@type': 'Organization',
    name: 'Sri Janaki Mahal Trust',
    logo: { '@type': 'ImageObject', url: 'https://www.srijanakimahaltrustofficial.com/favicon.svg' },
  },
  image: ['https://www.srijanakimahaltrustofficial.com/og.jpg'],
};
---

<Layout
  title={`${post.title} | श्री जानकी महल ट्रस्ट ब्लॉग`}
  description={post.description}
  keywords={keywords}
  canonical={`/hi/blog/${slug}`}
  ogType="article"
  ogImage="/og.jpg"
  lang="hi"
>
  <Fragment slot="head">
    <meta property="article:published_time" content={publishedIso} />
    <meta property="article:modified_time" content={publishedIso} />
    <meta property="article:section" content="अयोध्या गाइड" />
  </Fragment>

  <Header />

  <main class="min-h-screen bg-[#faf8f3] py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="mb-6 text-sm" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-gray-600">
          <li><a href="/hi" class="hover:text-amber-600">Home</a></li>
          <li>/</li>
          <li><a href="/hi/blog" class="hover:text-amber-600">Blog</a></li>
          <li>/</li>
          <li class="text-gray-900">{post.title}</li>
        </ol>
      </nav>

      <header class="mb-8">
        <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 mb-4">{post.title}</h1>
        <div class="flex items-center gap-4 text-sm text-gray-600 mb-6">
          <time datetime={post.date}>
            {new Date(post.date).toLocaleDateString('hi-IN', { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
          <span>•</span>
          <span>{post.readTime ?? '5 min read'}</span>
        </div>
        <p class="text-xl text-gray-700 leading-relaxed">{post.description}</p>
      </header>

      <article class="bg-white rounded-lg shadow-lg p-8 prose prose-lg max-w-none">
        <Content />
      </article>

      <div class="mt-10 bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-3">Verified Booking Links</h2>
        <ul class="list-disc list-inside text-gray-700 space-y-2">
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/official-booking">आधिकारिक बुकिंग</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/booking-verification-guide">बुकिंग सत्यापन गाइड</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/how-to-avoid-scams">फर्जी बुकिंग से बचें</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/rooms">कमरे और कीमत</a></li>
        </ul>
      </div>

      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Related Articles</h2>
        <div class="grid md:grid-cols-2 gap-6">
          {relatedPosts.map((relatedPost) => (
            <a href={`/hi/blog/${relatedPost.slug}`} class="block bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
              <h3 class="text-xl font-bold text-gray-900 mb-2 hover:text-amber-600">{relatedPost.frontmatter.title}</h3>
              <p class="text-gray-600 text-sm mb-3">{relatedPost.frontmatter.description}</p>
              <span class="text-amber-600 font-semibold text-sm">Read more →</span>
            </a>
          ))}
        </div>
      </div>
    </div>
  </main>

  {breadcrumbSchema && <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />}
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <Footer />
</Layout>

