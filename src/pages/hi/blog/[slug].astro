<!-- // src/pages/hi/blog/[slug].astro -->
---
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import { generateBreadcrumbSchema, generateStandardBreadcrumbs } from '../../../lib/schemas/breadcrumb';
import { DISPLAY_PHONE, TEL_LINK, WHATSAPP_BOOKING_LINK_HI } from '../../../lib/constants';

type MarkdownModule = {
  frontmatter: {
    title: string;
    description: string;
    date: string;
    keywords?: string[];
    readTime?: string;
    wordCount?: number;
  };
  Content: any;
  compiledContent?: () => Promise<string>;
  rawContent?: string | (() => Promise<string>);
};

type BlogEntry = {
  slug: string;
  frontmatter: MarkdownModule['frontmatter'];
  Content: MarkdownModule['Content'];
};

export async function getStaticPaths() {
  const getReadingStats = (content: string | undefined) => {
    const safeContent = content?.trim();
    if (!safeContent) {
      return {
        readTime: '5 मिनट पढ़ें',
        wordCount: 0,
      };
    }

    const words = safeContent.split(/\s+/).filter(Boolean).length;
    const minutes = Math.max(1, Math.round(words / 200));
    return {
      readTime: `${minutes} मिनट पढ़ें`,
      wordCount: words,
    };
  };

  const blogImports = import.meta.glob('../../../content/blog/hi/*.md');
  const englishBlogImports = import.meta.glob('../../../content/blog/*.md');
  const englishSlugs = new Set(
    Object.keys(englishBlogImports).map((path) => path.split('/').pop()?.replace('.md', '') ?? '')
  );
  const entries: BlogEntry[] = await Promise.all(
    Object.entries(blogImports).map(async ([path, resolver]) => {
      const mod = (await resolver()) as MarkdownModule;
      const slug = path.split('/').pop()?.replace('.md', '') ?? '';

      let rawContent = '';
      if (typeof mod.rawContent === 'string') rawContent = mod.rawContent;
      else if (typeof mod.rawContent === 'function') rawContent = await mod.rawContent();
      else if (typeof mod.compiledContent === 'function') rawContent = await mod.compiledContent();

      const readingStats = getReadingStats(rawContent);
      const readTime = mod.frontmatter.readTime ?? readingStats.readTime;
      const wordCount = mod.frontmatter.wordCount ?? readingStats.wordCount;
      return {
        slug,
        frontmatter: { ...mod.frontmatter, readTime, wordCount },
        Content: mod.Content,
      };
    })
  );

  entries.sort((a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime());
  const allPosts = entries.map(({ slug, frontmatter }) => ({ slug, frontmatter }));

  return entries.map(({ slug, frontmatter, Content }) => ({
    params: { slug },
    props: { slug, frontmatter, Content, allPosts, hasEnglishAlternate: englishSlugs.has(slug) },
  }));
}

const { slug, frontmatter, Content, allPosts, hasEnglishAlternate } = Astro.props as {
  slug: string;
  frontmatter: MarkdownModule['frontmatter'];
  Content: MarkdownModule['Content'];
  allPosts: Array<{ slug: string; frontmatter: MarkdownModule['frontmatter'] }>;
  hasEnglishAlternate: boolean;
};

const post = { slug, ...frontmatter };
const baseKeywords = [
  'श्री जानकी महल ट्रस्ट',
  'अयोध्या रूम बुकिंग',
  'राम मंदिर के पास ठहरना',
  'सत्यापित बुकिंग',
];
const keywordSet = new Set([...(baseKeywords as string[]), ...(post.keywords ?? [])]);
const keywords = Array.from(keywordSet);
const contentLabels = {
  home: 'होम',
  blog: 'ब्लॉग',
  verifiedLinks: 'सत्यापित बुकिंग लिंक',
  relatedArticles: 'संबंधित लेख',
  readMore: 'पूरा पढ़ें →',
  fallbackReadTime: '5 मिनट पढ़ें',
};

const relatedPosts = allPosts.filter((entry) => entry.slug !== slug).slice(0, 3);

const breadcrumbs = generateStandardBreadcrumbs('Blog', '/hi/blog');
breadcrumbs.push({ name: post.title, url: `/hi/blog/${slug}` });
const breadcrumbSchema = generateBreadcrumbSchema(breadcrumbs);

const canonicalUrl = `https://www.srijanakimahaltrustofficial.com/hi/blog/${slug}`;
const publishedIso = new Date(post.date).toISOString();
const alternateLanguages = hasEnglishAlternate
  ? [
      { lang: 'en', url: `/blog/${slug}` },
      { lang: 'hi', url: `/hi/blog/${slug}` },
    ]
  : [{ lang: 'hi', url: `/hi/blog/${slug}` }];

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  mainEntityOfPage: { '@type': 'WebPage', '@id': canonicalUrl },
  headline: post.title,
  description: post.description,
  datePublished: publishedIso,
  dateModified: publishedIso,
  inLanguage: 'hi-IN',
  articleSection: 'अयोध्या यात्रा गाइड',
  keywords: keywords.join(', '),
  wordCount: post.wordCount,
  author: { '@type': 'Organization', name: 'Sri Janaki Mahal Trust', url: 'https://www.srijanakimahaltrustofficial.com/' },
  publisher: {
    '@type': 'Organization',
    name: 'Sri Janaki Mahal Trust',
    logo: { '@type': 'ImageObject', url: 'https://www.srijanakimahaltrustofficial.com/favicon.svg' },
  },
  image: ['https://www.srijanakimahaltrustofficial.com/og.jpg'],
};
---

<Layout
  title={`${post.title} | ब्लॉग`}
  description={post.description}
  keywords={keywords}
  canonical={`/hi/blog/${slug}`}
  ogType="article"
  ogImage="/og.jpg"
  lang="hi"
  alternateLanguages={alternateLanguages}
  disableDefaultHreflangPair={true}
>
  <Fragment slot="head">
    <meta property="article:published_time" content={publishedIso} />
    <meta property="article:modified_time" content={publishedIso} />
    <meta property="article:section" content="अयोध्या गाइड" />
  </Fragment>

  <Header />

  <main class="min-h-screen bg-[#faf8f3] py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="mb-6 text-sm" aria-label="ब्रेडक्रम्ब">
        <ol class="flex items-center gap-2 text-gray-600">
          <li><a href="/hi" class="hover:text-amber-600">{contentLabels.home}</a></li>
          <li>/</li>
          <li><a href="/hi/blog" class="hover:text-amber-600">{contentLabels.blog}</a></li>
          <li>/</li>
          <li class="text-gray-900">{post.title}</li>
        </ol>
      </nav>

      <header class="mb-8">
        {/* Keep visual title while preserving single semantic H1 in markdown content */}
        <p class="text-4xl sm:text-5xl font-bold text-gray-900 mb-4">{post.title}</p>
        <div class="flex items-center gap-4 text-sm text-gray-600 mb-6">
          <time datetime={post.date}>
            {new Date(post.date).toLocaleDateString('hi-IN', { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
          <span>•</span>
          <span>{post.readTime ?? contentLabels.fallbackReadTime}</span>
        </div>
        <p class="text-xl text-gray-700 leading-relaxed">{post.description}</p>
      </header>

      <article class="bg-white rounded-lg shadow-lg p-8 prose prose-lg max-w-none">
        <Content />
      </article>

      <div class="mt-12 bg-gradient-to-r from-amber-600 to-rose-600 rounded-lg p-8 text-center text-white">
        <h2 class="text-2xl font-bold mb-4">श्री जानकी महल ट्रस्ट में रूम बुक करें</h2>
        <p class="text-lg mb-6 opacity-90">
          राम मंदिर के पास भोजन सहित कमरे। तुरंत बुकिंग के लिए कॉल/WhatsApp करें।
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href={TEL_LINK}
            class="px-6 py-3 bg-white text-amber-700 font-bold rounded-lg hover:bg-gray-100 transition-colors"
          >
            कॉल: {DISPLAY_PHONE}
          </a>
          <a
            href={WHATSAPP_BOOKING_LINK_HI}
            target="_blank"
            rel="noopener noreferrer"
            class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors"
          >
            WhatsApp बुकिंग
          </a>
        </div>
      </div>

      <div class="mt-10 bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-3">{contentLabels.verifiedLinks}</h2>
        <ul class="list-disc list-inside text-gray-700 space-y-2">
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/official-booking">आधिकारिक बुकिंग</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/booking">बुकिंग पेज</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/contact-number">आधिकारिक संपर्क नंबर</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/room-prices">रूम प्राइस/टैरिफ</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/amenities">सुविधाएँ (भोजन सहित)</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/how-to-avoid-scams">फर्जी बुकिंग से बचें</a></li>
          <li><a class="text-amber-700 font-semibold hover:underline" href="/hi/rooms">कमरे (डिटेल्स)</a></li>
        </ul>
      </div>

      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">{contentLabels.relatedArticles}</h2>
        <div class="grid md:grid-cols-2 gap-6">
          {relatedPosts.map((relatedPost) => (
            <a href={`/hi/blog/${relatedPost.slug}`} class="block bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
              <h3 class="text-xl font-bold text-gray-900 mb-2 hover:text-amber-600">{relatedPost.frontmatter.title}</h3>
              <p class="text-gray-600 text-sm mb-3">{relatedPost.frontmatter.description}</p>
              <span class="text-amber-600 font-semibold text-sm">{contentLabels.readMore}</span>
            </a>
          ))}
        </div>
      </div>
    </div>
  </main>

  {breadcrumbSchema && <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />}
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <Footer />
</Layout>

